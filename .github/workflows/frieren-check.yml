name: Frieren Check

on:
  schedule:
    # 毎週水曜日 日本時間9:00 (UTC 0:00)
    - cron: '0 0 * * 3'
  workflow_dispatch: # 手動実行用

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Frieren in next issue
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          pip install beautifulsoup4 requests

          python3 << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          import subprocess
          import os

          url = "https://websunday.net/sunday/next/"
          response = requests.get(url)
          response.encoding = response.apparent_encoding
          soup = BeautifulSoup(response.text, "html.parser")

          content_main = soup.find("div", class_="content__main")

          topic = os.environ.get("NTFY_TOPIC")

          if content_main and "フリーレン" in content_main.get_text():
              print("フリーレン found!")
              subprocess.run([
                  "curl", "-d", "次号のサンデーにフリーレンが掲載されます！",
                  "-H", "Title: フリーレン掲載あり",
                  "-H", "Priority: high",
                  "-H", "Tags: sparkles",
                  f"https://ntfy.sh/{topic}"
              ])
          else:
              print("フリーレン not found.")
              subprocess.run([
                  "curl", "-d", "次号のサンデーにフリーレンの掲載はありません",
                  "-H", "Title: フリーレン掲載なし"
                  "-H", "Priority: default",
                  "-H", "Tags: eyes",
                  f"https://ntfy.sh/{topic}"
              ])
          EOF
